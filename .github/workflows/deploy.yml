name: ğŸš€ Simple Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      # Step 1: Get the code from the repository
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Step 2: Install Terraform
      - name: ğŸ› ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.5.0"

      # Step 3: See what Terraform will create (good for validation)
      - name: ğŸ“‹ Terraform Plan
        run: terraform plan
        working-directory: ./terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # Step 4: Create the AWS infrastructure (EC2 instance, security group, etc.)
      - name: âœ… Terraform Apply
        run: terraform apply -auto-approve
        working-directory: ./terraform
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # Step 5: Get the server's public IP address from Terraform output
      - name: ğŸ“ Get IP Address
        id: get-ip
        run: |
          # Wait a moment for Terraform output to be available
          sleep 10
          # Extract the public IP address from Terraform output
          IP=$(terraform output -raw public_ip)
          # Store the IP in an environment variable for the next step
          echo "IP_ADDRESS=$IP" >> $GITHUB_ENV
          echo "Server IP: $IP"
        working-directory: ./terraform

      # Step 6: Deploy the application using Ansible
      - name: ğŸš€ Deploy with Ansible
        run: |
          # Create SSH directory and set up the private key
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          
          # Add the server to known_hosts to avoid manual confirmation
          ssh-keyscan -H $IP_ADDRESS 2>/dev/null >> ~/.ssh/known_hosts || true
          
          # Run Ansible to install Docker and deploy the application
          ansible-playbook -i "$IP_ADDRESS," ansible/playbook.yml --private-key=~/.ssh/deploy_key.pem -u ubuntu
          
          # Display success message with URLs
          echo "ğŸ‰ Deployment complete!"
          echo "ğŸŒ WordPress available at: http://$IP_ADDRESS"
          echo "ğŸ“Š Grafana available at: http://$IP_ADDRESS/grafana"